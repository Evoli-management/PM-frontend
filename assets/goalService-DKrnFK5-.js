const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/milestoneService-BxAk0tA1.js","assets/index-gqUiuoFX.js","assets/index-CH3sAiQw.css"])))=>i.map(i=>d[i]);
import{f as n,_ as g}from"./index-gqUiuoFX.js";const c=(t,e)=>{if(console.error(`Error ${t}:`,e),e.response&&e.response.data&&e.response.data.message){const r=Array.isArray(e.response.data.message)?e.response.data.message.join(", "):e.response.data.message;throw console.error("Backend validation errors:",r),new Error(`Failed to ${t}. ${r}`)}throw new Error(`Failed to ${t}. ${e.message||"Please try again."}`)},w=async()=>{try{const t=await n.get("/goals");return Array.isArray(t.data)?await Promise.all(t.data.map(async r=>{try{return await d(r.id)}catch(o){return console.warn(`Failed to fetch milestones for goal ${r.id}:`,o),{...r,milestones:[]}}})):t.data}catch(t){c("fetching goals",t)}},d=async t=>{try{const r=(await n.get(`/goals/${t}`)).data;return{...r,milestones:r.milestones||[]}}catch(e){c(`fetching goal ${t}`,e)}},m=async t=>{try{console.log("Creating goal with data:",t);const e={title:t.title,description:t.description||null,visibility:t.visibility||"public"};t.dueDate&&(e.dueDate=new Date(t.dueDate).toISOString()),t.startDate&&(e.startDate=new Date(t.startDate).toISOString()),t.keyAreaId&&(e.keyAreaId=t.keyAreaId),t.parentGoalId&&(e.parentGoalId=t.parentGoalId),t.milestones&&Array.isArray(t.milestones)&&t.milestones.length>0?e.milestones=t.milestones.filter(o=>o.title&&o.title.trim()).map(o=>({title:o.title.trim(),weight:parseFloat(o.weight)||1,dueDate:o.dueDate?new Date(o.dueDate).toISOString():null})):e.milestones=[{title:"Complete goal",weight:1,dueDate:e.dueDate||null}],console.log("Sending clean goal data to backend:",e);const r=await n.post("/goals",e);return console.log("Backend create response:",r.data),r.data}catch(e){c("creating goal",e)}},u=async t=>{var e;try{console.log("Archiving goal:",t);try{return(await n.patch(`/goals/${t}/archive`)).data}catch(r){if(((e=r.response)==null?void 0:e.status)===404)return console.log("Archive endpoint not found, trying update with visibility=archived"),(await n.patch(`/goals/${t}`,{visibility:"archived"})).data;throw r}}catch(r){c("archiving goal",r)}},v=async(t,e)=>{try{return console.log("Toggling visibility for goal:",t,"from:",e),await p(t,{visibility:e==="public"?"private":"public"})}catch(r){throw console.error("Toggle visibility error:",r),r}},A=async(t,e)=>{try{return console.log("Updating progress for goal:",t,"to:",e),await p(t,{progressPercent:e})}catch(r){throw console.error("Update progress error:",r),r}},b=async(t={})=>{try{const e=new URLSearchParams;t.status&&e.append("status",t.status),t.keyAreaId&&e.append("keyAreaId",t.keyAreaId),t.parentId!==void 0&&e.append("parentId",t.parentId),t.q&&e.append("q",t.q);const r=e.toString(),o=r?`/goals?${r}`:"/goals";return(await n.get(o)).data}catch(e){c("fetching filtered goals",e)}},h=async t=>{var e,r,o;try{console.log("Attempting to complete goal:",t);try{console.log("Trying PUT /complete endpoint");const s=await n.put(`/goals/${t}/complete`);return console.log("Complete endpoint response:",s.data),s.data}catch(s){if(((e=s.response)==null?void 0:e.status)===404){console.log("PUT /complete not found, trying PATCH");try{const i=await n.patch(`/goals/${t}/complete`);return console.log("PATCH complete response:",i.data),i.data}catch(i){if(((r=i.response)==null?void 0:r.status)===404){console.log("PATCH /complete not found, trying POST");try{const l=await n.post(`/goals/${t}/complete`);return console.log("POST complete response:",l.data),l.data}catch(l){if(((o=l.response)==null?void 0:o.status)===404){console.log("No dedicated complete endpoint found, trying regular update");try{const a=await n.patch(`/goals/${t}`,{visibility:"public",title:void 0});return await d(t)}catch{throw new Error("All completion methods failed. Backend may not support goal completion.")}}throw l}}throw i}}throw s}}catch(s){console.error("All goal completion attempts failed:",s),c("completing goal",s)}},p=async(t,e)=>{var r;try{if(e.status==="completed")return console.log("Status change to completed - using complete endpoint"),await h(t);if(e.status==="archived")return console.log("Status change to archived - using archive endpoint"),await u(t);if(e.status&&Object.keys(e).length===1)throw console.log("Status-only update detected, status field not allowed in update DTO"),new Error("Status updates must use dedicated endpoints (complete/archive)");if(e.status!==void 0){console.log("Removing status field from update data (not allowed in update DTO)");const{status:s,...i}=e;e=i}if(e.milestones&&Array.isArray(e.milestones)){console.log("Handling milestone updates separately");const{updateMilestone:s}=await g(async()=>{const{updateMilestone:a}=await import("./milestoneService-BxAk0tA1.js");return{updateMilestone:a}},__vite__mapDeps([0,1,2]));for(const a of e.milestones)a.id&&await s(a.id,{title:a.title,...a.done!==void 0&&{done:a.done},weight:a.weight,dueDate:a.dueDate?new Date(a.dueDate).toISOString():null});const{milestones:i,...l}=e;if(Object.keys(l).length>0)e=l;else return await d(t)}const o={};if(e.title!==void 0&&(o.title=e.title),e.description!==void 0&&(o.description=e.description),e.visibility!==void 0&&(o.visibility=e.visibility),e.dueDate!==void 0&&(o.dueDate=e.dueDate?new Date(e.dueDate).toISOString():null),e.startDate!==void 0&&(o.startDate=e.startDate?new Date(e.startDate).toISOString():null),e.keyAreaId!==void 0&&(o.keyAreaId=e.keyAreaId||null),e.parentGoalId!==void 0&&(o.parentGoalId=e.parentGoalId||null),e.progressPercent!==void 0&&(o.progressPercent=Math.min(100,Math.max(0,Number(e.progressPercent)))),console.log("Sending clean data to backend:",o),o.dueDate&&o.startDate){const s=new Date(o.dueDate),i=new Date(o.startDate);if(s<=i)throw new Error("Due date must be after start date")}try{const s=await n.patch(`/goals/${t}`,o);return console.log("PATCH update response:",s.data),s.data}catch(s){if(((r=s.response)==null?void 0:r.status)===404){console.log("PATCH not supported, falling back to PUT");const i=await n.put(`/goals/${t}`,o);return console.log("PUT update response:",i.data),i.data}throw s}}catch(o){if(console.error("Goal update error:",o),o.response){if(console.error("Error response:",o.response.data),o.response.status===500)throw console.error("500 Error - Backend logs might show more details"),new Error("Server error occurred. Check backend logs for details.");if(o.response.status===404)throw new Error("Goal not found or update endpoint not available.");if(o.response.status===400)throw new Error(`Bad request: ${o.response.data.message||"Invalid data"}`)}c("updating goal",o)}},S=async t=>{var e;try{try{return console.log("Attempting soft delete via PATCH"),await n.patch(`/goals/${t}/archive`),!0}catch(r){if(((e=r.response)==null?void 0:e.status)===404){console.log("Archive endpoint not found, trying alternative deletion approach");try{return console.log("Attempting to archive goal"),await n.patch(`/goals/${t}`,{visibility:"archived"}),!0}catch(o){return console.error("Archive attempt failed:",o),await n.delete(`/goals/${t}`),!0}}throw r}}catch(r){console.error("All deletion attempts failed:",r),c("deleting goal",r)}};export{u as archiveGoal,h as completeGoal,m as createGoal,S as deleteGoal,b as getFilteredGoals,d as getGoalById,w as getGoals,v as toggleGoalVisibility,p as updateGoal,A as updateGoalProgress};
